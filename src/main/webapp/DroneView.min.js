var parameters={ipServidor:"localhost",puertoServidor:"8080",velocidadRotacion:.07,aceleracion:.04,distanciaAviso:150,tiempoEntreAvisos:3,baseConsumoCombustible:.05,cantidadAvisosParaDisparar:2,masaBarcosPesados:90,masaBarcosLivianos:45,masaHelicoptero:22,masaBote:32,milla200_distancia:100,metaPesca:100,ametralladoraAlcance:125,ametralladoraDanio:20,ametralladoraCadencia:1,canionAlcance:150,canionDanio:40,canionCadencia:3},globalDroneVariables={websocket:null,websocketTime:null,equipo:null,barcosCargados:0,light:null,spotlight:null,spotlight2:null,rain:null,distanciaAviso:150,enemigoActivo:null,fish:null,pesquero:null,milla200:null,vehiculoVolviendo:!1,flagMostrarDisparo:!1,patrulleroDispara:null,barcoImpactadoDisparo:null,nivelDanioDisparo:0,texto:null,textoTiempo:null,textoTormenta:null,textoPesca:null,moverArriba:null,moverIzquierda:null,moverDerecha:null,cambiarBarcoActivo:null,seleccionarBarcoPesado:null,seleccionarBarcoLiviano:null,desacoplarHelicoptero:null,desacoplarBote:null,avisarPesquero:null,dispararAmetralladora:null,dispararCanion:null,inmovilizarPesquero:null,restaurarPartida:!1,teclaGuardarPartida:null,teclaTormenta:null,avisarPesqueroJustPressed:!1,administradorActualizado:!1,particlesExplosion:null,particlesShot:null,particlesRain:null,InfoVehiculo_Info1:null,InfoVehiculo_Info2:null,InfoVehiculo_Info3:null,InfoVehiculo_Info4:null,InfoVehiculo_Info5:null,InfoVehiculo_Info1T:null,InfoVehiculo_Info2T:null,InfoVehiculo_Info3T:null,InfoVehiculo_Info4T:null,InfoVehiculo_Info5T:null},partida={tiempoRestantePartida:null,hayGanador:!1,hayTormenta:!1,teclaTormenta:!1,guardarPartida:!1,restaurarPartida:!1,partidaPendienteRestaurar:!1,equipoAdministrador:"",Pesqueros:{Barcos:[]},Patrulleros:{Barcos:[]},Disparo:{existe:!1,patrullero:null,pesquero:null,arma:null,impacto:!1},Pesca:{BancoPeces:[]}},DroneViewState=new Phaser.Class({Extends:Phaser.Scene,initialize:function(){Phaser.Scene.call(this,{key:"DroneView"})},preload:function(){$.getJSON("parameters.json",function(a){parameters=a}),this.load.image("patrulleroLivianoTop","assets/patrulleroLivianoTop.png"),this.load.image("patrulleroPesadoTop","assets/patrulleroPesadoTop.png"),this.load.image("patrulleroHelicopteroTop","assets/patrulleroHelicopteroTop.png"),this.load.image("patrulleroBoteTop","assets/patrulleroBoteTop.png"),this.load.image("pesqueroLivianoTop","assets/pesqueroLivianoTop.png"),this.load.image("pesqueroPesadoTop","assets/pesqueroPesadoTop.png"),this.load.image("water","assets/water.jpg"),this.load.image("fishes","assets/fishes.png"),this.load.image("mask","assets/mask.png"),this.load.image("panel","assets/panel.png"),this.load.image("horizontal","assets/horizontal.png"),this.load.image("vertical","assets/vertical.png"),this.load.image("fire","assets/muzzleflash3.png"),this.load.atlas("flares","assets/flares.png","assets/flares.json")},create:function(){globalDroneVariables.equipo=getVarsFromUrl().equipo,globalDroneVariables.restaurarPartida=getVarsFromUrl().recuperar,"true"==globalDroneVariables.restaurarPartida?(partida.restaurarPartida=!0,partida.partidaPendienteRestaurar=!0):(partida.restaurarPartida=!1,partida.partidaPendienteRestaurar=!1),globalDroneVariables.desacoplarHelicoptero=this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.H),globalDroneVariables.desacoplarBote=this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.B),globalDroneVariables.avisarPesquero=this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.A),globalDroneVariables.dispararAmetralladora=this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.Z),globalDroneVariables.dispararCanion=this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.X),globalDroneVariables.inmovilizarPesquero=this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.I),globalDroneVariables.cambiarBarcoPropio=this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SHIFT),globalDroneVariables.cambiarBarcoEnemigo=this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.CTRL),globalDroneVariables.moverArriba=this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.UP),globalDroneVariables.moverIzquierda=this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.LEFT),globalDroneVariables.moverDerecha=this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.RIGHT),globalDroneVariables.teclaGuardarPartida=this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.G),globalDroneVariables.teclaTormenta=this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.T),this.matter.world.setBounds(0,0,1200,650);this.add.image(600,325,"water"),this.add.image(1432,325,"panel");var a=this.add.graphics();globalDroneVariables.milla200=new Phaser.Curves.Line(new Phaser.Math.Vector2(0,parameters.milla200_distancia),new Phaser.Math.Vector2(1200,parameters.milla200_distancia)),a.clear(),a.lineStyle(2,16777215,1),globalDroneVariables.milla200.draw(a),globalDroneVariables.spotlight=this.make.sprite({x:200,y:150,key:"mask",add:!1});var e=this.add.image(600,560,"fishes");e.mask=new Phaser.Display.Masks.BitmapMask(this,globalDroneVariables.spotlight);var o=this.add.image(300,440,"fishes");o.mask=new Phaser.Display.Masks.BitmapMask(this,globalDroneVariables.spotlight);var r=this.add.image(600,440,"fishes");r.mask=new Phaser.Display.Masks.BitmapMask(this,globalDroneVariables.spotlight);var i=this.add.image(900,440,"fishes");i.mask=new Phaser.Display.Masks.BitmapMask(this,globalDroneVariables.spotlight);var t=this.add.image(200,320,"fishes");t.mask=new Phaser.Display.Masks.BitmapMask(this,globalDroneVariables.spotlight);var s=this.add.image(400,320,"fishes");s.mask=new Phaser.Display.Masks.BitmapMask(this,globalDroneVariables.spotlight);var l=this.add.image(700,320,"fishes");l.mask=new Phaser.Display.Masks.BitmapMask(this,globalDroneVariables.spotlight);var n=this.add.image(500,200,"fishes");n.mask=new Phaser.Display.Masks.BitmapMask(this,globalDroneVariables.spotlight);var p=this.add.image(1e3,200,"fishes");p.mask=new Phaser.Display.Masks.BitmapMask(this,globalDroneVariables.spotlight),globalDroneVariables.pesquero=this.matter.add.image(400,50,"pesqueroLivianoTop"),globalDroneVariables.pesquero.setFrictionAir(.15),globalDroneVariables.pesquero.setMass(parameters.masaBarcosLivianos),globalDroneVariables.pesquero.setFixedRotation(),globalDroneVariables.pesquero.setAngle(270),globalDroneVariables.pesquero.mask=new Phaser.Display.Masks.BitmapMask(this,globalDroneVariables.spotlight);var d=this.matter.add.image(800,50,"pesqueroPesadoTop");d.setFrictionAir(.15),d.setMass(parameters.masaBarcosPesados),d.setFixedRotation(),d.setAngle(270),d.mask=new Phaser.Display.Masks.BitmapMask(this,globalDroneVariables.spotlight);var c=this.matter.add.image(200,300,"patrulleroLivianoTop");c.setFrictionAir(.15),c.setMass(parameters.masaBarcosLivianos),c.setFixedRotation(),c.setAngle(270),c.mask=new Phaser.Display.Masks.BitmapMask(this,globalDroneVariables.spotlight);var u=this.matter.add.image(1e3,300,"patrulleroPesadoTop");u.setFrictionAir(.15),u.setMass(parameters.masaBarcosPesados),u.setFixedRotation(),u.setAngle(270),u.mask=new Phaser.Display.Masks.BitmapMask(this,globalDroneVariables.spotlight);var b=this.matter.add.image(1e3,300,"patrulleroHelicopteroTop");b.setFrictionAir(.15),b.setMass(parameters.masaBarcosPesados),b.setFixedRotation(),b.setAngle(270),b.mask=new Phaser.Display.Masks.BitmapMask(this,globalDroneVariables.spotlight);var m=this.matter.add.image(1e3,300,"patrulleroBoteTop");m.setFrictionAir(.15),m.setMass(parameters.masaBarcosPesados),m.setFixedRotation(),m.setAngle(270),m.mask=new Phaser.Display.Masks.BitmapMask(this,globalDroneVariables.spotlight),globalDroneVariables.websocket=new WebSocket("ws://"+parameters.ipServidor+":"+parameters.puertoServidor+"/taller3/juego/"+globalDroneVariables.equipo),globalDroneVariables.websocketTime=new WebSocket("ws://"+parameters.ipServidor+":"+parameters.puertoServidor+"/taller3/acciones/"+globalDroneVariables.equipo),globalDroneVariables.textoTiempo=this.add.text(1220,30,"Tiempo: "+formatTime(partida.tiempoRestantePartida)),globalDroneVariables.textoTormenta=this.add.text(1220,10,"No hay tormenta"),this.add.text(1220,72,"INFO VEHICULO "),globalDroneVariables.textoPesca=this.add.text(1220,50," "),globalDroneVariables.InfoVehiculo_Info1T=this.add.text(1220,100," "),globalDroneVariables.InfoVehiculo_Info1=this.add.text(1220,120," "),globalDroneVariables.InfoVehiculo_Info2T=this.add.text(1220,150," "),globalDroneVariables.InfoVehiculo_Info2=this.add.text(1220,170," "),globalDroneVariables.InfoVehiculo_Info3T=this.add.text(1220,200," "),globalDroneVariables.InfoVehiculo_Info3=this.add.text(1220,220," "),globalDroneVariables.InfoVehiculo_Info4T=this.add.text(1220,250," "),globalDroneVariables.InfoVehiculo_Info4=this.add.text(1220,270," "),globalDroneVariables.InfoVehiculo_Info5T=this.add.text(1220,300," "),globalDroneVariables.InfoVehiculo_Info5=this.add.text(1220,320," "),this.add.text(1220,390,"CONTROLES"),this.add.text(1220,430,"CURSORES: "),this.add.text(1220,450,"Mover barco"),this.add.text(1220,470,"SHIFT: Cambiar"),this.add.text(1220,490,"barco propio"),"Patrullero"==globalDroneVariables.equipo&&(this.add.text(1220,510,"CTRL: Cambiar"),this.add.text(1220,530,"enemigo"),this.add.text(1220,550,"H: Helicoptero"),this.add.text(1220,570,"B: Bote"),this.add.text(1220,590,"A: Aviso"),this.add.text(1220,610,"Z: Metralleta"),this.add.text(1220,630,"X: Canion"));var h={id:1,type:"B",size:"Liviano",sprite:globalDroneVariables.pesquero,cantidadPesca:0,combustible:1e5,contadorAvisos:0,ultimoAvisoRecibido:null,vida:100,activo:"Pesquero"==globalDroneVariables.equipo,hundido:!1,regresando:!1,capturado:!1},g={id:2,type:"B",size:"Pesado",sprite:d,cantidadPesca:0,combustible:1e5,contadorAvisos:0,ultimoAvisoRecibido:null,vida:100,activo:!1,hundido:!1,regresando:!1,capturado:!1},D={id:3,type:"B",size:"Liviano",sprite:c,armas:{ametralladora:{cadencia:parameters.ametralladoraCadencia,nivelDanio:parameters.ametralladoraDanio,alcance:parameters.ametralladoraAlcance,ultimoDisparo:null}},combustible:100,activo:"Patrullero"==globalDroneVariables.equipo,regresando:!1},v={id:5,type:"H",acoplado:!0,sprite:b,combustible:100,activo:!1,regresando:!1},V={id:6,type:"L",acoplado:!0,sprite:m,combustible:100,activo:!1,regresando:!1},P={id:4,type:"B",size:"Pesado",sprite:u,armas:{ametralladora:{cadencia:parameters.ametralladoraCadencia,nivelDanio:parameters.ametralladoraDanio,alcance:parameters.ametralladoraAlcance,ultimoDisparo:null},canion:{cadencia:parameters.canionCadencia,nivelDanio:parameters.canionDanio,alcance:parameters.canionAlcance,ultimoDisparo:null}},combustible:100,activo:!1,helicoptero:v,bote:V},f={id:8,activo:!0,sprite:e,peces:40},y={id:9,activo:!0,sprite:o,peces:20},T={id:10,activo:!0,sprite:r,peces:20},x={id:11,activo:!0,sprite:i,peces:20},I={id:12,activo:!0,sprite:t,peces:10},B={id:13,activo:!0,sprite:s,peces:10},A={id:14,activo:!0,sprite:l,peces:10},q={id:15,activo:!0,sprite:n,peces:5},k={id:16,activo:!0,sprite:p,peces:5};partida.Pesca.BancoPeces.push(f),partida.Pesca.BancoPeces.push(y),partida.Pesca.BancoPeces.push(T),partida.Pesca.BancoPeces.push(x),partida.Pesca.BancoPeces.push(I),partida.Pesca.BancoPeces.push(B),partida.Pesca.BancoPeces.push(A),partida.Pesca.BancoPeces.push(q),partida.Pesca.BancoPeces.push(k),partida.Patrulleros.Barcos.push(D),partida.Patrulleros.Barcos.push(P),partida.Pesqueros.Barcos.push(h),partida.Pesqueros.Barcos.push(g);var w=this.matter.add.image(600,650,"horizontal",null,{restitution:.4,isStatic:!0}),C=this.matter.add.image(600,0,"horizontal",null,{restitution:.4,isStatic:!0}),M=this.matter.add.image(0,325,"vertical",null,{restitution:.4,isStatic:!0}),R=this.matter.add.image(1200,325,"vertical",null,{restitution:.4,isStatic:!0}),_=this.matter.world.nextCategory();h.sprite.setCollisionCategory(_),g.sprite.setCollisionCategory(_);var K=this.matter.world.nextCategory();D.sprite.setCollisionCategory(K);var H=this.matter.world.nextCategory();P.sprite.setCollisionCategory(H),V.sprite.setCollisionCategory(H);var S=this.matter.world.nextCategory();w.setCollisionCategory(S),C.setCollisionCategory(S),M.setCollisionCategory(S),R.setCollisionCategory(S),h.sprite.setCollidesWith([_,K,H,S]),g.sprite.setCollidesWith([_,K,H,S]),D.sprite.setCollidesWith([_,H,S]),V.sprite.setCollidesWith([_,K,S]),P.sprite.setCollidesWith([_,K,S]);globalDroneVariables.pesquero;this.matter.world.on("collisionstart",function(a,e,o){(7==e.id&&12==o.id||12==e.id&&7==o.id)&&vehiculoDentroMilla200(partida.Pesqueros.Barcos[0])&&vehiculoDentroMilla200(getBoatWithHelicopter().bote)&&capturarBarco(partida.Pesqueros.Barcos[0])}),globalDroneVariables.particlesExplosion=this.add.particles("fire"),globalDroneVariables.particlesShot=this.add.particles("flares"),globalDroneVariables.particlesRain=this.add.particles("flares"),console.log("create success")},update:function(){globalDroneVariables.administradorActualizado||partida.equipoAdministrador!=globalDroneVariables.equipo||(globalDroneVariables.administradorActualizado=!0,"Pesquero"==globalDroneVariables.equipo?(this.add.text(1220,510,":ADMIN:"),this.add.text(1220,530,"G: Guardar")):(this.add.text(1220,650,":ADMIN:"),this.add.text(1220,670,"G: Guardar")));var a=null;("Patrullero"==globalDroneVariables.equipo?a=partida.Patrulleros.Barcos.find(function(a){return a.activo}):((a=partida.Pesqueros.Barcos.find(function(a){return a.activo})).hundido||a.capturado)&&(a=partida.Pesqueros.Barcos.find(function(a){return!a.hundido&&!a.capturado})),null==a||null==a)&&((u=partida.Patrulleros.Barcos.find(function(a){return void 0!==a.helicoptero})).helicoptero.activo?a=u.helicoptero:u.bote.activo&&(a=u.bote));if("Patrullero"==globalDroneVariables.equipo){var e=[];partida.Pesqueros.Barcos.forEach(function(o){Phaser.Math.Distance.Between(a.sprite.x,a.sprite.y,o.sprite.x,o.sprite.y)<=parameters.distanciaAviso&&!o.hundido&&!o.capturado&&vehiculoDentroMilla200(o)&&e.push(o)}),e.length?null==globalDroneVariables.enemigoActivo&&(globalDroneVariables.enemigoActivo=e[0]):globalDroneVariables.enemigoActivo=null}switch(globalDroneVariables.textoPesca.setText("Pesca:"+getPescaTotal()+"/"+parameters.metaPesca),a.type){case"B":if("Patrullero"==globalDroneVariables.equipo){globalDroneVariables.InfoVehiculo_Info1T.setText("Tipo:"),globalDroneVariables.InfoVehiculo_Info1.setText("PATRULLA"),globalDroneVariables.InfoVehiculo_Info2T.setText("Categoria:"),globalDroneVariables.InfoVehiculo_Info2.setText(a.size.toUpperCase()),globalDroneVariables.InfoVehiculo_Info3T.setText("Combustible:"),globalDroneVariables.InfoVehiculo_Info3.setText(Math.round(a.combustible)),globalDroneVariables.InfoVehiculo_Info4T.setText("Enemigo selec.:");var o="NINGUNO";null!==globalDroneVariables.enemigoActivo&&(o="PESQUERO "+globalDroneVariables.enemigoActivo.size.toUpperCase()),globalDroneVariables.InfoVehiculo_Info4.setText(o);var r="Avisos: NA",i="Vida: NA";null!==globalDroneVariables.enemigoActivo&&(r="Avisos: "+globalDroneVariables.enemigoActivo.contadorAvisos,i="Vida: "+globalDroneVariables.enemigoActivo.vida),globalDroneVariables.InfoVehiculo_Info5T.setText(r),globalDroneVariables.InfoVehiculo_Info5.setText(i)}else globalDroneVariables.InfoVehiculo_Info1T.setText("Tipo:"),globalDroneVariables.InfoVehiculo_Info1.setText("PESQUERO"),globalDroneVariables.InfoVehiculo_Info2T.setText("Categoria:"),globalDroneVariables.InfoVehiculo_Info2.setText(a.size.toUpperCase()),globalDroneVariables.InfoVehiculo_Info3T.setText("Vida:"),globalDroneVariables.InfoVehiculo_Info3.setText(a.vida),globalDroneVariables.InfoVehiculo_Info4T.setText("Pesca:"),globalDroneVariables.InfoVehiculo_Info4.setText(a.cantidadPesca),globalDroneVariables.InfoVehiculo_Info5T.setText("Avisos:"),globalDroneVariables.InfoVehiculo_Info5.setText(a.contadorAvisos);break;case"H":globalDroneVariables.InfoVehiculo_Info1T.setText("Tipo:"),globalDroneVariables.InfoVehiculo_Info1.setText("PATRULLA"),globalDroneVariables.InfoVehiculo_Info2T.setText("Categoria:"),globalDroneVariables.InfoVehiculo_Info2.setText("HELICOPTERO"),globalDroneVariables.InfoVehiculo_Info3T.setText("Combustible:"),globalDroneVariables.InfoVehiculo_Info3.setText(Math.round(a.combustible));break;case"L":globalDroneVariables.InfoVehiculo_Info1T.setText("Tipo:"),globalDroneVariables.InfoVehiculo_Info1.setText("PATRULLA"),globalDroneVariables.InfoVehiculo_Info2T.setText("Categoria:"),globalDroneVariables.InfoVehiculo_Info2.setText("BOTE"),globalDroneVariables.InfoVehiculo_Info3T.setText("Combustible:"),globalDroneVariables.InfoVehiculo_Info3.setText(Math.round(a.combustible))}if("undefined"!==getBoatWithHelicopter()){var t=getBoatWithHelicopter().helicoptero,s=getBoatWithHelicopter().bote;t.acoplado&&(t.sprite.x=getBoatWithHelicopter().sprite.x,t.sprite.y=getBoatWithHelicopter().sprite.y,t.sprite.rotation=getBoatWithHelicopter().sprite.rotation),s.acoplado&&(s.sprite.x=getBoatWithHelicopter().sprite.x,s.sprite.y=getBoatWithHelicopter().sprite.y,s.sprite.rotation=getBoatWithHelicopter().sprite.rotation)}var l=!1;null!=globalDroneVariables.websocket&&(globalDroneVariables.websocket.onmessage=function(e){if(null!=e.data){var o=JSON.parse(e.data);partida.hayTormenta=o.hayTormenta,partida.teclaTormenta=o.teclaTormenta,""!=o.equipoAdministrador&&(partida.equipoAdministrador=o.equipoAdministrador),partida.Patrulleros.Barcos.forEach(function(e){var r=o.Patrulleros.Barcos.find(function(a){return a.id==e.id});(r.id!==a.id||partida.partidaPendienteRestaurar)&&setMovement(e,r.sprite),e.combustible=r.combustible,void 0!==r.helicoptero&&"H"!=a.type&&(setMovement(e.helicoptero,r.helicoptero.sprite),e.helicoptero.combustible=r.helicoptero.combustible,e.helicoptero.acoplado=r.helicoptero.acoplado),void 0!==r.bote&&"L"!=a.type&&(setMovement(e.bote,r.bote.sprite),e.bote.combustible=r.bote.combustible,e.bote.acoplado=r.bote.acoplado)}),partida.Pesqueros.Barcos.forEach(function(e){var r=o.Pesqueros.Barcos.find(function(a){return a.id==e.id});if((r.id!==a.id||partida.partidaPendienteRestaurar)&&setMovement(e,r.sprite),e.combustible=r.combustible,e.capturado=r.capturado,e.vida=r.vida,e.contadorAvisos=r.contadorAvisos,e.ultimoAvisoRecibido=r.ultimoAvisoRecibido,e.cantidadPesca=r.cantidadPesca,o.Disparo.existe&&o.Disparo.impacto&&e.id==o.Disparo.pesquero.id){var i=partida.Pesqueros.Barcos.find(function(a){return a.id==e.id});i.vida>0?(mostrarDisparo(o.Disparo.patrullero.sprite,i.sprite,o.Disparo.arma.nivelDanio/133),mostrarExplosion(i.sprite,o.Disparo.arma.nivelDanio),globalDroneVariables.patrulleroDispara=o.Disparo.patrullero,globalDroneVariables.barcoImpactadoDisparo=i,globalDroneVariables.nivelDanioDisparo=o.Disparo.arma.nivelDanio,globalDroneVariables.flagMostrarDisparo=!0,i.vida>o.Disparo.arma.nivelDanio?i.vida-=o.Disparo.arma.nivelDanio:(i.vida=0,i.hundido=!0,i.sprite.x=1300,i.sprite.setVisible(!1))):(i.hundido=!0,i.sprite.x=1300,i.sprite.setVisible(!1)),l=!0}}),partida.partidaPendienteRestaurar=o.partidaPendienteRestaurar,partida.restaurarPartida=o.partidaPendienteRestaurar,partida.Pesca.BancoPeces.forEach(function(a){var e=o.Pesca.BancoPeces.find(function(e){return e.id==a.id});a.cantidadPesca=e.cantidadPesca,a.activo=e.activo,a.sprite.setVisible(e.sprite.visible)})}o.hayGanador&&(evaluarPatrullerosGanadores()?window.location.replace("gameover.html?equipoGanador=Patrullero"):evaluarPesquerosGanadores()&&window.location.replace("gameover.html?equipoGanador=Pesquero"),globalDroneVariables.websocket.close(),globalDroneVariables.websocketTime.close())}),null!=globalDroneVariables.websocket&&(globalDroneVariables.websocket.onclose=function(){globalDroneVariables.websocket=null}),null!=globalDroneVariables.websocketTime&&(globalDroneVariables.websocketTime.onclose=function(){globalDroneVariables.websocketTime=null});var n=!1;globalDroneVariables.moverIzquierda.isDown&&a.combustible>0&&!a.regresando?(a.sprite.rotation-=parameters.velocidadRotacion,void 0!==a.helicoptero&&a.helicoptero.acoplado&&(a.helicoptero.sprite.rotation-=parameters.velocidadRotacion),void 0!==a.bote&&a.bote.acoplado&&(a.bote.sprite.rotation-=parameters.velocidadRotacion),n=!0):globalDroneVariables.moverDerecha.isDown&&a.combustible>0&&!a.regresando&&(a.sprite.rotation+=parameters.velocidadRotacion,void 0!==a.helicoptero&&a.helicoptero.acoplado&&(a.helicoptero.sprite.rotation+=parameters.velocidadRotacion),void 0!==a.bote&&a.bote.acoplado&&(a.bote.sprite.rotation+=parameters.velocidadRotacion),n=!0),globalDroneVariables.moverArriba.isDown&&a.combustible>0&&!a.regresando&&(a.sprite.thrust(parameters.aceleracion),void 0!==a.helicoptero&&a.helicoptero.acoplado&&a.helicoptero.sprite.thrust(parameters.aceleracion),void 0!==a.bote&&a.bote.acoplado&&a.bote.sprite.thrust(parameters.aceleracion),n=!0),n&&"H"!=a.type&&consumirCombustible(a);var p=partida.Patrulleros.Barcos.find(function(a){return void 0!==a.helicoptero});!p.helicoptero.regresando&&p.helicoptero.acoplado||(moveAutomatically(p.helicoptero),consumirCombustible(p.helicoptero)),(partida.hayTormenta&&!p.bote.acoplado||"L"==a.type&&a.regresando&&!a.acoplado||p.bote.regresando&&!p.bote.acoplado)&&(returnToShip(p.bote),moveAutomatically(p.bote),consumirCombustible(p.bote)),globalDroneVariables.spotlight.x=a.sprite.x,globalDroneVariables.spotlight.y=a.sprite.y,"Pesquero"==globalDroneVariables.equipo&&n&&partida.Pesca.BancoPeces.forEach(function(e){Phaser.Math.Distance.Between(a.sprite.x,a.sprite.y,e.sprite.x,e.sprite.y)<50&&e.activo&&(e.activo=!1,a.cantidadPesca+=e.peces,e.sprite.setVisible(!1))});var d=null;Phaser.Input.Keyboard.JustDown(globalDroneVariables.cambiarBarcoPropio)&&(d="Pesquero"==globalDroneVariables.equipo?partida.Pesqueros.Barcos.find(function(a){return!a.activo&&!a.hundido&&!a.capturado}):partida.Patrulleros.Barcos.find(function(a){return!a.activo})),null!=d&&(a.activo=!1,d.activo=!0);var c=!1;if(Phaser.Input.Keyboard.JustDown(globalDroneVariables.desacoplarHelicoptero)&&"Patrullero"==globalDroneVariables.equipo){var u=partida.Patrulleros.Barcos.find(function(a){return void 0!==a.helicoptero});a.activo=!1,u.helicoptero.activo=!0,u.helicoptero.acoplado=!1,u.helicoptero.sprite.setMass(parameters.masaHelicoptero),c=!0}if(Phaser.Input.Keyboard.JustDown(globalDroneVariables.desacoplarBote)&&"Patrullero"==globalDroneVariables.equipo&&!partida.hayTormenta){var b=partida.Patrulleros.Barcos.find(function(a){return void 0!==a.bote});a.activo=!1,b.bote.activo=!0,b.bote.acoplado=!1,b.bote.sprite.setMass(parameters.masaBote),c=!0}var m=null;Phaser.Input.Keyboard.JustDown(globalDroneVariables.cambiarBarcoEnemigo)&&"Patrullero"==globalDroneVariables.equipo&&(m=e.find(function(a){return a.id!=globalDroneVariables.enemigoActivo.id}),globalDroneVariables.enemigoActivo=m);var h=!1;if(Phaser.Input.Keyboard.JustDown(globalDroneVariables.avisarPesquero)&&"Patrullero"==globalDroneVariables.equipo&&"B"==a.type&&vehiculoDentroMilla200(a)&&e&&e.length&&null!==globalDroneVariables.enemigoActivo&&vehiculoDentroMilla200(globalDroneVariables.enemigoActivo)){h=!0;var g=partida.Pesqueros.Barcos.find(function(a){return a.id==globalDroneVariables.enemigoActivo.id});g.contadorAvisos<parameters.cantidadAvisosParaDisparar&&(null!==g.ultimoAvisoRecibido?tiempoUltimoAvisoCumplido(g.ultimoAvisoRecibido)&&(g.contadorAvisos++,g.ultimoAvisoRecibido=partida.tiempoRestantePartida):(g.contadorAvisos++,g.ultimoAvisoRecibido=partida.tiempoRestantePartida))}var D=!1;(partida.Disparo.existe=!1,Phaser.Input.Keyboard.JustDown(globalDroneVariables.dispararCanion))&&("Patrullero"==globalDroneVariables.equipo&&"B"==a.type&&"Pesado"==a.size&&vehiculoDentroMilla200(a)&&null!==globalDroneVariables.enemigoActivo&&2==globalDroneVariables.enemigoActivo.contadorAvisos&&tiempoUltimoAvisoCumplido(globalDroneVariables.enemigoActivo.ultimoAvisoRecibido)&&vehiculoDentroMilla200(globalDroneVariables.enemigoActivo)&&(null==a.armas.canion.ultimoDisparo||a.armas.canion.ultimoDisparo-partida.tiempoRestantePartida>=a.armas.canion.cadencia)&&Phaser.Math.Distance.Between(a.sprite.x,a.sprite.y,globalDroneVariables.enemigoActivo.sprite.x,globalDroneVariables.enemigoActivo.sprite.y)<=a.armas.canion.alcance&&(partida.Disparo.existe=!0,partida.Disparo.patrullero=a,partida.Disparo.pesquero=globalDroneVariables.enemigoActivo,a.armas.canion.ultimoDisparo=partida.tiempoRestantePartida,partida.Disparo.arma=a.armas.canion,partida.Disparo.impacto=!0,D=!0));Phaser.Input.Keyboard.JustDown(globalDroneVariables.dispararAmetralladora)&&("Patrullero"==globalDroneVariables.equipo&&"B"==a.type&&vehiculoDentroMilla200(a)&&null!==globalDroneVariables.enemigoActivo&&vehiculoDentroMilla200(globalDroneVariables.enemigoActivo)&&2==globalDroneVariables.enemigoActivo.contadorAvisos&&tiempoUltimoAvisoCumplido(globalDroneVariables.enemigoActivo.ultimoAvisoRecibido)&&(null==a.armas.ametralladora.ultimoDisparo||a.armas.ametralladora.ultimoDisparo-partida.tiempoRestantePartida>=a.armas.ametralladora.cadencia)&&Phaser.Math.Distance.Between(a.sprite.x,a.sprite.y,globalDroneVariables.enemigoActivo.sprite.x,globalDroneVariables.enemigoActivo.sprite.y)<=a.armas.ametralladora.alcance&&(partida.Disparo.existe=!0,partida.Disparo.patrullero=a,partida.Disparo.pesquero=globalDroneVariables.enemigoActivo,a.armas.ametralladora.ultimoDisparo=partida.tiempoRestantePartida,partida.Disparo.arma=a.armas.ametralladora,partida.Disparo.impacto=!0,D=!0));var v=!1;!getBoatWithHelicopter().helicoptero.acoplado&&vehiculoDentroMilla200(partida.Pesqueros.Barcos[1])&&vehiculoDentroMilla200(getBoatWithHelicopter().helicoptero)&&(Phaser.Math.Distance.Between(getBoatWithHelicopter().helicoptero.sprite.x,getBoatWithHelicopter().helicoptero.sprite.y,partida.Pesqueros.Barcos[1].sprite.x,partida.Pesqueros.Barcos[1].sprite.y)<25&&(capturarBarco(partida.Pesqueros.Barcos[1]),v=!0));Phaser.Input.Keyboard.JustDown(globalDroneVariables.teclaGuardarPartida)&&(partida.guardarPartida=!0,globalDroneVariables.administradorActualizado&&partida.equipoAdministrador==globalDroneVariables.equipo&&(globalDroneVariables.administradorActualizado=!0,"Pesquero"==globalDroneVariables.equipo?this.add.text(1220,550,"Guardado OK"):this.add.text(1220,690,"Guardado OK")));var V=!1;!partida.hayTormenta&&Phaser.Input.Keyboard.JustDown(globalDroneVariables.teclaTormenta)&&(partida.teclaTormenta=!0,partida.hayTormenta=!0,V=!0),partida.hayTormenta&&Phaser.Input.Keyboard.JustDown(globalDroneVariables.teclaTormenta)&&(partida.teclaTormenta=!0,partida.hayTormenta=!1,V=!0),partida.hayTormenta?globalDroneVariables.textoTormenta.setText("Hay tormenta!!"):globalDroneVariables.textoTormenta.setText("No hay tormenta"),(evaluarPatrullerosGanadores()||evaluarPesquerosGanadores())&&(partida.hayGanador=!0),(n||D||h||v||l||globalDroneVariables.vehiculoVolviendo||partida.guardarPartida||partida.restaurarPartida||V||c||partida.hayGanador)&&enviarJSON(partida),null!=globalDroneVariables.websocketTime&&(globalDroneVariables.websocketTime.onmessage=function(a){if(null!=a.data){let e=JSON.parse(a.data);switch(e.accion){case"tiempo":partida.tiempoRestantePartida=e.tiempoRestante,globalDroneVariables.textoTiempo.setText("Tiempo: "+formatTime(partida.tiempoRestantePartida));break;case"salida":partida.hayGanador||partida.tiempoRestantePartida>=1&&("Patrullero"==globalDroneVariables.equipo?window.location.replace("error.html?equipoAbandono=Pesquero"):"Pesquero"==globalDroneVariables.equipo&&window.location.replace("error.html?equipoAbandono=Patrullero"),globalDroneVariables.websocket.close(),globalDroneVariables.websocketTime.close())}}}),partida.hayTormenta&&mostrarLluvia(),partida.guardarPartida=!1}});function getVarsFromUrl(){var a={};window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(e,o,r){a[o]=r});return a}function enviarJSON(a){let e=JSON.stringify(a);null!=globalDroneVariables.websocket&&globalDroneVariables.websocket.readyState===WebSocket.OPEN&&globalDroneVariables.websocket.send(e)}function formatTime(a){return minutes=Math.floor(a/60),a%=60,("0"+minutes).slice(-2)+":"+("0"+a).slice(-2)}function setMovement(a,e){a.sprite.x=e.x,a.sprite.y=e.y,a.sprite.rotation=e.rotation}function consumirCombustible(a){let e=parameters.baseConsumoCombustible;if(a.combustible>0)switch(a.type){case"B":"Liviano"==a.size?a.combustible-=e/2:a.combustible-=e;break;case"H":a.combustible-=8*e,returnToShip(a);break;case"L":a.combustible-=4*e,returnToShip(a)}}function returnToShip(a){if(a.combustible<50||partida.hayTormenta&&"L"==a.type){var e=new Phaser.Math.Vector2;e.x=getBoatWithHelicopter().sprite.x,e.y=getBoatWithHelicopter().sprite.y;var o=Phaser.Math.Angle.Between(a.sprite.x,a.sprite.y,e.x,e.y);Phaser.Math.Angle.Wrap(o-a.sprite.rotation);a.sprite.rotation=o,a.sprite.setAngularVelocity(0),a.sprite.target=e,a.sprite.thrust(0),a.sprite.thrust(parameters.aceleracion),a.regresando=!0,moveAutomatically(a)}}function moveAutomatically(a){if(null!=a.sprite.target){var e=Phaser.Math.Distance.Between(a.sprite.x,a.sprite.y,a.sprite.target.x,a.sprite.target.y);a.sprite.body.speed>0&&a.regresando&&(globalDroneVariables.vehiculoVolviendo=!0,e<4&&(a.sprite.thrust(0),a.sprite.body.speed=0,a.regresando=!1,a.acoplado=!0,a.combustible=100,a.activo=!1,a.sprite.x=getBoatWithHelicopter().sprite.x,a.sprite.y=getBoatWithHelicopter().sprite.y,a.sprite.setAngle(getBoatWithHelicopter().sprite.angle),a.sprite.rotation=getBoatWithHelicopter().sprite.rotation,a.sprite.setMass(parameters.masaBarcosPesados),a.sprite.setFixedRotation(),getBoatWithHelicopter().activo=!0,globalDroneVariables.vehiculoVolviendo=!1))}}function tiempoUltimoAvisoCumplido(a){return a-partida.tiempoRestantePartida>=parameters.tiempoEntreAvisos}function getBoatWithHelicopter(){return partida.Patrulleros.Barcos.find(function(a){return void 0!==a.helicoptero})}function vehiculoDentroMilla200(a){return a.sprite.y>parameters.milla200_distancia}function capturarBarco(a){2==a.contadorAvisos&&tiempoUltimoAvisoCumplido(a.ultimoAvisoRecibido)&&(a.combustible=0,a.vida=0,a.capturado=!0)}function getPescaTotal(){var a=0;return partida.Pesqueros.Barcos.forEach(function(e){a+=e.cantidadPesca}),a}function evaluarPesquerosGanadores(){return getPescaTotal()>=parameters.metaPesca}function evaluarPatrullerosGanadores(){var a=0;return partida.Pesqueros.Barcos.forEach(function(e){(e.capturado||e.hundido)&&a++}),2==a||0==partida.tiempoRestantePartida}function mostrarExplosion(a,e){globalDroneVariables.particlesExplosion.createEmitter({alpha:{start:1,end:0},scale:{start:.5,end:e/20},tint:{start:16749662,end:16749662},speed:50,accelerationY:-100,angle:{min:-85,max:-95},rotate:{min:-180,max:180},lifespan:{min:1e3,max:1050},blendMode:"ADD",frequency:50,maxParticles:3,x:a.x,y:a.y})}function mostrarDisparo(a,e,o){globalDroneVariables.particlesShot.createEmitter({frame:"yellow",x:a.x,y:a.y,lifespan:200,speed:{min:400,max:600},angle:Phaser.Math.RAD_TO_DEG*Phaser.Math.Angle.Between(a.x,a.y,e.x,e.y),gravityY:0,scale:{start:o,end:0},quantity:2,blendMode:"ADD",maxParticles:10})}function mostrarLluvia(){globalDroneVariables.particlesRain.createEmitter({frame:"blue",x:{min:0,max:1200},y:0,lifespan:1e3,speedY:800,scaleY:.5,scaleX:.01,quantity:10,blendMode:"ADD",maxParticles:5})}myGame.scenes.push(DroneViewState);