<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
	<title>Phaser - Factibilidad</title>
	<script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
	<script src='https://cdn.jsdelivr.net/npm/sockjs-client@1.1/dist/sockjs.min.js'></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">
function JugadorServer(nombre, x, y)
{
	this.nombre = nombre;
	this.x = x;
	this.y = y;
}
var config = {
    type: Phaser.AUTO,
    width: 800,
    height: 600,
    physics: {
        default: 'arcade',
        arcade: {
            gravity: { y: 0 },
            debug: false
        }
    },
    scene: {
        preload: preload,
        create: create,
        update: update
    }
};

//definiciones de phaser
var game = new Phaser.Game(config);
var cursors;
var bote1, patrullero1, jugador;

//definicion de cual comando
var manejo = "";
var texto;
var jugador; 

var selBoton1,selBoton2;
var jugadorServerBote1,jugadorServerPatrullero1;

function preload() {
	
    //carga las imagenes al juego√ß
    this.load.image('sky', 'assets/sky.png');
    this.load.image('bote1', 'assets/bote1.png');
    this.load.image('patrullero1', 'assets/patrullero1.png');
    this.load.image('botonBote1', 'assets/btn_bote.png');
    this.load.image('botonPatrullero1', 'assets/btn_patrullero.png');	
}



function create() {
    
    cursors = this.input.keyboard.createCursorKeys();
    this.add.image(400, 300, 'sky');
    const selBoton1 = this.add.sprite(600,120, 'botonBote1')
      .setInteractive()
      .on('pointerdown', function () {
          manejo = 'bote1';
          jugador = bote1;
          jugadorServerBote1 = new JugadorServer('bote1', 600,120);
      });
    	

      const selBoton2 = this.add.sprite(600,220, 'botonPatrullero1')
      .setInteractive()
      .on('pointerdown', function () {
          manejo = 'patrullero1';
          jugador = patrullero1;
          jugadorServerPatrullero1 = new JugadorServer('patrullero1', 600,220);
      });

      bote1 = this.physics.add.sprite(100, 200, 'bote1');
      
      patrullero1 = this.physics.add.sprite(200, 300, 'patrullero1');
      patrullero1.setCollideWorldBounds(true);
	
      websocket = new WebSocket('ws://localhost:8080/taller3/juego/');
      websocket.onmessage = function(event) {
  	    if(event.data != null)
  	    {
  	    	let jugadorServer = JSON.parse(event.data);
  	    	if(jugadorServer.nombre == 'bote1'){
  	    		jugador = bote1;
  	    		jugadorServerBote1=jugadorServer;
  	    	}
  	    	else{
  	    		jugador = patrullero1;
  	    		jugadorServerPatrullero1=jugadorServer;
  	    	}
  	    	jugador.x = jugadorServer.x;
  	    	jugador.y = jugadorServer.y;
  	    	
  	    }
      };
    
    texto = this.add.text(550, 580, "Controla la patrulla:" + manejo, { font: "14px Arial", fill: "#ff0044"});
}

function enviarJSON(objeto) {
	console.log('enviarJSON');
    let json = JSON.stringify(objeto);
    websocket.send(json);
}

function update() {

//actualiza las imagenes cuando te vas moviendo
    texto.setText("Controla la patrulla:" + manejo);
	this.add.text(550, 0, "envia al servidor", { font: "14px Arial", fill: "#ff0044"});
    
	if (jugador != null && !(typeof jugador === 'undefined'))
    {
        jugador.setVelocity(0);
    
        if (cursors.left.isDown)
        {
            jugador.setVelocityX(-100);
        }
        else if (cursors.right.isDown)
        {
            jugador.setVelocityX(100);
        }

        if (cursors.up.isDown)
        {
            jugador.setVelocityY(-100);
        }
        else if (cursors.down.isDown)
        {
            jugador.setVelocityY(100);
        }

        if(manejo == 'bote1' && jugadorServerBote1 != null){
	        jugadorServerBote1.x = jugador.x;
	        jugadorServerBote1.y = jugador.y;
	        enviarJSON(jugadorServerBote1);
        }
        else{
        	if(jugadorServerPatrullero1 != null){
	        	jugadorServerPatrullero1.x = jugador.x;
	        	jugadorServerPatrullero1.y = jugador.y;
	        	enviarJSON(jugadorServerPatrullero1);
        	}
        }
        
    }

}

</script>

</body>
</html>