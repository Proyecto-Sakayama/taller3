<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
	<title>Phaser - Factibilidad</title>
	<script src="//cdn.jsdelivr.net/npm/phaser@3.22.0/dist/phaser.js"></script>
	<script src='https://cdn.jsdelivr.net/npm/sockjs-client@1.1/dist/sockjs.min.js'></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">
function JugadorServer(nombre, x, y, angle)
{
	this.nombre = nombre;
	this.x = x;
	this.y = y;
	this.angle = angle;
}
var config = {
    type: Phaser.WEBGL,
    width: 800,
    height: 600,
    physics: {
        default: 'matter',
        matter: {
            gravity: {
                x: 0,
                y: 0
            }
        }
    },
    scene: {
        preload: preload,
        create: create,
        update: update,
        extend: {
            minimap: null,
            bote1: null,
            patrullero1: null,
            cursors: null
        }
    }
};

//definiciones de phaser
var game = new Phaser.Game(config);
var cursors;
var bote1, patrullero1, jugador;

//definicion de cual comando
var manejo = "";
var texto;
var jugador;
var jugadorRemoto;

var selBoton1,selBoton2;
var jugadorServerRecibido, jugadorServerEnviado;

function preload() {
	
    //carga las imagenes al juego√ß
    this.load.image('sky', 'assets/sky_big.png');
    this.load.image('bote1', 'assets/bote1_h.png');
    this.load.image('patrullero1', 'assets/patrullero1_h.png');
    this.load.image('botonBote1', 'assets/btn_bote.png');
    this.load.image('botonPatrullero1', 'assets/btn_patrullero.png');	
}



function create() {
	 //  The world is 3200 x 600 in size
	this.matter.world.setBounds(0, 0, 3200, 600);
    this.cameras.main.setBounds(0, 0, 3200, 600).setName('main');

    //  The miniCam is 400px wide, so can display the whole world at a zoom of 0.2
    this.minimap = this.cameras.add(200, 10, 400, 100).setZoom(0.2).setName('mini');
    this.minimap.setBackgroundColor(0x002244);
    this.minimap.scrollX = 1600;
    this.minimap.scrollY = 300;
	
    this.add.image(400, 300, 'sky');
    bote1 = this.matter.add.image(100, 200, 'bote1');
    //bote1.setCollideWorldBounds(true);
    
    bote1.setFrictionAir(0.15);
    bote1.setMass(30);
    bote1.setFixedRotation();
    bote1.setAngle(270);
    
    patrullero1 = this.matter.add.image(200, 300, 'patrullero1');
    //patrullero1.setCollideWorldBounds(true);
    
    patrullero1.setFrictionAir(0.15);
    patrullero1.setMass(30);
    patrullero1.setFixedRotation();
    patrullero1.setAngle(270);
    

    websocket = new WebSocket('ws://localhost:8080/taller3/juego/');
    cursors = this.input.keyboard.createCursorKeys();
    texto = this.add.text(550, 580, "Controla la patrulla:" + manejo, { font: "14px Arial", fill: "#ff0044"});
}

function enviarJSON(objeto) {
	console.log('enviarJSON');
    let json = JSON.stringify(objeto);
    websocket.send(json);
}

function update() {
	websocket.onmessage = function(event) {
	    if(event.data != null)
	    {
	    	//defino el jugador
	    	if(typeof jugador === 'undefined')
	    	{
	    		let nombre = JSON.parse(event.data);
	    		manejo = nombre;
	    		if(nombre == 'bote1')
	    		{
	    			jugador = bote1;
// 	    			jugadorRemoto = patrullero1;
	    		}
	    		else 
	    		{
	    			if(nombre == 'patrullero1')
	    			{
	    				jugador = patrullero1;
// 	    				jugadorRemoto = bote1;
	    			}
	    			
	    		}
	    	}
	    	else
	    	{
	  	    	let jugadorServer = JSON.parse(event.data);
	  	    	if(jugador == bote1 && jugadorServer.nombre != 'bote1'){
	  	    		//jugador = bote1;
	  	    		jugadorRemoto = patrullero1;
	  	    	}
	  	    	else{
	  	    		if(jugador == patrullero1 && jugadorServer.nombre != 'patrullero1'){
		  	    		//jugador = patrullero1;
		  	    		jugadorRemoto = bote1;
	  	    		}
	  	    	}
	  	    //actualizo rival
	  	    	if(jugadorRemoto != null && !(typeof jugadorRemoto === 'undefined') &&  jugadorServer.nombre != manejo)
	  	    	{
	  	    		jugadorRemoto.x = jugadorServer.x;
		  	    	jugadorRemoto.y = jugadorServer.y;
		  	    	jugadorRemoto.angle = jugadorServer.angle;
	  	    	}
	    	}
	    }
  };
//actualiza las imagenes cuando te vas moviendo
    texto.setText("Controla la patrulla:" + manejo);
	this.add.text(550, 0, "envia al servidor", { font: "14px Arial", fill: "#ff0044"});
    
	if (jugador != null && !(typeof jugador === 'undefined'))
    {		
		if (cursors.left.isDown)
	    {
			jugador.setAngularVelocity(-0.1);
	    }
	    else if (cursors.right.isDown)
	    {
	    	jugador.setAngularVelocity(0.1);
	    }
	
	    if (cursors.up.isDown)
	    {
	    	jugador.thrust(0.08);
	    }
        let jugadorServer = new JugadorServer(manejo, jugador.x, jugador.y, jugador.angle);
        enviarJSON(jugadorServer);
        
   		 //  Position the center of the camera on the player
        //  We -400 because the camera width is 800px and
        //  we want the center of the camera on the player, not the left-hand side of it
        this.cameras.main.scrollX = jugador.x - 400;

        //  And this camera is 400px wide, so -200
        this.minimap.scrollX = Phaser.Math.Clamp(jugador.x - 200, 800, 2000);
    }
	

}

</script>

</body>
</html>